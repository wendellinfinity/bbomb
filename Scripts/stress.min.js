var CONSTANTS={CanvasID:"stress",WispDefaultFill:"#F00D13",WispDefaultStroke:"#BADBAD",WispDefaultStrokeSize:5,WispMovementSpeed:2,WispCapturedMovementSpeed:0.5,WispNeutralizedColor:"green",WispDangerColor:"red",CanvasWidth:688,CanvasHeight:388,CanvasColor:"#DDD",WispStartCoords:{x:(688/2)-20,y:50},FrameRate:200,FrameSkip:0,WispDefaultRadius:20,TimerDefaults:{WispLife:1000,WispDBNO:0,WispStep:10,Interval:100,PercentageDiv:1000,WispTimerCoords:{x:0,y:0},WispTimerRadius:15,WispTimerColor:"#4A04A0",WispTimerWidth:5},JarDefaults:{RightJar:{Top:120,Left:608,Width:85,Height:145,Fill:"#F00D13",Stroke:"#333",StrokeWidth:3,JarID:0},LeftJar:{Top:120,Left:-8,Width:85,Height:145,Fill:"#BADF00",Stroke:"#333",StrokeWidth:3,JarID:1}},MaxJarCapacity:7};function StressGame(){var d=new Kinetic.Stage({container:CONSTANTS.CanvasID,width:CONSTANTS.CanvasWidth,height:CONSTANTS.CanvasHeight,});var e=new Kinetic.Layer();var h=new Kinetic.Layer();var c=[];var a=[];var g={background:e,interaction:h};this.init=function(){d.add(e);d.add(h);b()};function b(){var m=new Kinetic.Rect({x:0,y:0,width:CONSTANTS.CanvasWidth,height:CONSTANTS.CanvasHeight,fill:CONSTANTS.CanvasColor});e.add(m);var j=CONSTANTS.JarDefaults.RightJar;var k=new Jar(j,g);k.init();a.push(k);var l=CONSTANTS.JarDefaults.LeftJar;var i=new Jar(l,g);i.init();a.push(i);e.draw()}this.allWisps=c;function f(k,j){var i=new Wisp(k,j);i.init(i);return i}this.moreWisps=function(){var i=f(h,a);c.push(i)}}function Jar(c,e){var b;var a;var f=c;var d=[];this.getImage=function(){return b};this.getID=function(){return a};this.getSettings=function(){return f};this.init=function(){b=new Kinetic.Rect({x:c.Left,y:c.Top,width:c.Width,height:c.Height,fill:c.Fill,stroke:c.Stroke,strokeWidth:c.StrokeWidth});e.background.add(b);a=c.JarID};this.capture=function(g){if(d.length==CONSTANTS.MaxJarCapacity){var h=d.shift();h.stop();h.getImage().remove()}d.push(g)}}function Wisp(u,v){var D,e,a,b;var A;var c=null;var x=null;var j=false;var w=u.getStage();var q,f,k;var E;var h;var A;var l;var d;var t;var p;this.captured=l;this.getImage=function(){return D};this.stop=function(){c.stop();x.stop();q.stop()};this.init=function(G){var F=v[Math.round(Math.random()*(v.length-1))];p=G;d=F.getID();h=F.getSettings().Fill;e=new Kinetic.Circle({radius:CONSTANTS.WispDefaultRadius,fill:h,stroke:CONSTANTS.WispDefaultStroke,strokeWidth:CONSTANTS.WispDefaultStrokeSize});b=new Kinetic.Shape({drawFunc:o});D=new Kinetic.Group({x:CONSTANTS.WispStartCoords.x,y:CONSTANTS.WispStartCoords.y,draggable:true,startScale:1});D.add(e);D.add(b);D.on("dragstart",z);D.on("dragmove",y);D.on("mousedown",B);D.on("dragend",s);f=CONSTANTS.TimerDefaults.WispLife;q=new Kinetic.Animation(C,u);k=setInterval(function(){f-=CONSTANTS.TimerDefaults.WispStep;if(f<=CONSTANTS.TimerDefaults.WispDBNO){clearInterval(k)}},CONSTANTS.TimerDefaults.Interval);A=new Kinetic.Animation(m,u);u.add(D);q.start();i();isMoving=true};function z(){j=true;if(c){c.stop()}D.moveToTop();D.setAttrs({scale:{x:D.attrs.startScale*1.2,y:D.attrs.startScale*1.2}})}function y(){var L,I,G,K,F,H,J;L=D.getX();I=D.getY();hit=false;for(n=0;n<v.length;n++){jarImage=v[n].getImage();G=jarImage.getX();F=G+jarImage.getWidth();K=jarImage.getY();H=K+jarImage.getHeight();if(L>=G&&L<=F&&I>=K&&I<=H){hit=true;break}}if(!hit){if(D.getX()>=CONSTANTS.JarDefaults.RightJar.Left){D.setX(CONSTANTS.JarDefaults.RightJar.Left);return}if(D.getX()<=CONSTANTS.JarDefaults.LeftJar.Left+CONSTANTS.JarDefaults.LeftJar.Width){D.setX(CONSTANTS.JarDefaults.LeftJar.Left+CONSTANTS.JarDefaults.LeftJar.Width);return}}}function B(){if(x){x.stop()}}function s(){j=false;c=D.transitionTo({duration:0.5,easing:"elastic-ease-out",scale:{x:D.attrs.startScale,y:D.attrs.startScale},callback:function(){var L,I,G,K,F,H,J;L=D.getX();I=D.getY();for(n=0;n<v.length;n++){J=v[n].getImage();G=J.getX();F=G+J.getWidth();K=J.getY();H=K+J.getHeight();if(L>=G&&L<=F&&I>=K&&I<=H){if(d==v[n].getID()){t=v[n];r()}else{g()}}}i()}})}function C(G){var F=Math.round(G.time/CONSTANTS.FrameRate);if(F==CONSTANTS.FrameSkip){return}else{segsToSkip=F;b.remove();b=new Kinetic.Shape({drawFunc:o});D.add(b)}if(f<=CONSTANTS.TimerDefaults.WispDBNO){q.stop();return}}function o(G){var F=f/CONSTANTS.TimerDefaults.PercentageDiv;var I=F*360;var H=I*Math.PI/180;G.beginPath();G.lineWidth=CONSTANTS.TimerDefaults.WispTimerWidth;G.arc(CONSTANTS.TimerDefaults.WispTimerCoords.x,CONSTANTS.TimerDefaults.WispTimerCoords.y,CONSTANTS.TimerDefaults.WispTimerRadius,0,H,false);G.strokeStyle=CONSTANTS.TimerDefaults.WispTimerColor;G.stroke()}function m(G){var F=Math.round(G.time/CONSTANTS.FrameRate);if(F==CONSTANTS.FrameSkip){return}else{}}function r(){D.off("dragend dragstart mousedown");e.setFill(CONSTANTS.WispNeutralizedColor);l=true;t.capture(p)}function g(){alert("Game Over!")}function i(){var G,F,I;if(!l){G=Math.random()*w.getWidth()-CONSTANTS.JarDefaults.RightJar.Width;if(G<0){G+=CONSTANTS.JarDefaults.RightJar.Width}G+=(CONSTANTS.JarDefaults.LeftJar.Width+CONSTANTS.JarDefaults.LeftJar.Left);if(G>=CONSTANTS.JarDefaults.RightJar.Left){G=CONSTANTS.JarDefaults.RightJar.Left}F=Math.random()*w.getHeight()}else{var H=t.getImage();G=Math.random()*H.getWidth()+H.getX();F=Math.random()*H.getHeight()+H.getY()}x=D.transitionTo({x:G,y:F,duration:l?CONSTANTS.WispCapturedMovementSpeed:CONSTANTS.WispMovementSpeed,callback:function(){if(!j){i()}}})}}var sg=new StressGame();sg.init();